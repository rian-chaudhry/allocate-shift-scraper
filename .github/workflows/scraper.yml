name: shift-scraper

on:
  schedule:
    # BST window (06:00–21:50 UTC → 07:00–22:00 Europe/London)
    - cron: "*/10 6-21 * * *"
    # GMT window (07:00–21:50 UTC → 07:00–22:00 Europe/London)
    - cron: "*/10 7-21 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Jitter 4–37s to avoid perfect regularity
        run: |
          python - <<'PY'
          import random, time
          t = random.uniform(4, 37)
          print(f"Sleeping {t:.1f}s for jitter")
          time.sleep(t)
          PY

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps chromium

      - name: Run scraper
        env:
          # Provide Allocate + SMTP credentials to the script
          ALLOCATE_USER: ${{ secrets.ALLOCATE_USER }}
          ALLOCATE_PASS: ${{ secrets.ALLOCATE_PASS }}
          SMTP_HOST:     ${{ secrets.SMTP_HOST }}
          SMTP_PORT:     ${{ secrets.SMTP_PORT }}
          SMTP_USER:     ${{ secrets.SMTP_USER }}
          SMTP_PASS:     ${{ secrets.SMTP_PASS }}
          SMTP_FROM:     ${{ secrets.SMTP_FROM }}
          SMTP_TO:       ${{ secrets.SMTP_TO }}
        run: python scraper.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-artifacts
          path: artifacts
          if-no-files-found: ignore

      - name: Persist state files back to repo (seen_ids & storage_state)
        if: always()
        run: |
          git config user.name  "shift-bot"
          git config user.email "shift-bot@users.noreply.github.com"
          git add seen_ids.json storage_state.json || true
          git diff --cached --quiet && echo "No state changes" || git commit -m "Update state [skip ci]"
          git push || echo "Nothing to push"
